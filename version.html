<!doctype html>
<!-- V2k Radio Decompiler — Live Preview (Stable v2.3.9)
     Правки:
     • Исправлены все случаи SyntaxError (regex /\r?\n/, закрытые теги <script>/<body>)
     • Доделана функция addDemoSamples (не обрывается, не дублирует)
     • Сохранены: таймер, прогресс‑бар с ETA, блокировка кнопок, live‑preview
-->
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>V2k Radio Decompiler — Live Preview (Stable v2.3.9)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="data:image/png;base64,iVBORw0KGgo=" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--muted:#666}::-webkit-scrollbar {width: 0;}
    body{font-family:Inter, Arial, sans-serif;margin:12px;background:var(--bg);color:#111}
    .wrap{display:flex;gap:12px;align-items:flex-start}
    .left{width:420px;transition:width .25s ease,opacity .25s ease}
    body.sidebar-collapsed .left{width:0;opacity:0;pointer-events:none}
    .panel{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:12px}
    label{display:block;margin:8px 0}
    button{margin:6px 4px;padding:8px 10px;border-radius:6px;cursor:pointer}
    select,input,textarea{width:100%;box-sizing:border-box;padding:8px;border-radius:6px;border:1px solid #e6e9ef}
    canvas{background:#fff;border:1px solid #eee;border-radius:6px;display:block;width:100%;max-height:204px}
    pre{background:#fafbfd;padding:8px;border-radius:6px;max-height:360px;overflow:auto;white-space:pre-wrap}
    h1{margin:6px 0;font-size:20px}
    .small{font-size:13px;color:var(--muted)}
    .hint{font-size:12px;color:#444;margin-top:6px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .note{font-size:13px;color:#333;padding:8px;border-left:3px solid #ffd54f;background:#fff8e1;border-radius:4px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border-bottom:1px solid #eef;padding:6px 8px;text-align:left}
    th{background:#f3f5fb;font-weight:600}
    .badge{display:inline-block;padding:2px 6px;border-radius:999px;background:#eef;color:#333;font-size:12px;margin-left:6px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#e6f4ea;color:#1b7f3d;font-size:12px}
    .play{cursor:pointer;text-decoration:underline}
    .toolbar{display:flex;align-items:center;gap:8px}
    .ghost{background:#eef;border:1px solid #dde;border-radius:6px;padding:6px 10px}
    /* === Progress UI === */
    .progress-wrap{background:#fff;border:1px solid #e6e9ef;border-radius:8px;padding:10px;margin:8px 0;box-shadow:0 4px 12px rgba(0,0,0,.04)}
    .progress-row{display:flex;flex-direction:column;gap:6px}
    .progress-bar{position:relative;height:10px;background:#f0f3f9;border-radius:999px;overflow:hidden}
    .progress-fill{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,#7cc,#59a9ff);transition:width .15s ease}
    .progress-metrics{font-size:12px;color:#333;display:flex;gap:10px;align-items:center}
  </style>
</head>
<body>
  <div class="toolbar">
    <h1 style="flex:1 1 auto;margin-right:8px;text-align:center;font-size: 2em;">V2k «Frey Effect» Radio Decompiler</h1>
    <button id="btnToggleSidebar" class="ghost" title="Показать/скрыть левую панель">⟷</button>
  </div>
  <div id="progress" class="progress-wrap" style="display:none">
    <div class="progress-row">
      <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
      <div class="progress-metrics">
        <span id="progressPhase">—</span>
        <span id="progressPct">0%</span>
        <span id="progressElapsed">0.0s</span>
        <span id="progressEta">ETA —</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="left">
      <div class="panel">
        <h3>1) Источник сэмплов</h3>
  <!-- <div class="small">CDN: <code>https://cryptq.github.io/audio/samples_test/samples/</code></div> -->
        <div class="row" style="margin-top:8px">
          <button id="btnRetryList">Загрузить CDN</button>
          <button id="btnLoadDemo">Загрузить демо‑сэмплы</button>
        </div>
   <!-- <label style="margin-top:10px">ИЛИ — загрузите файлы:</label> -->
        <input id="fileInput" type="file" accept="audio/*" multiple />
        <div class="hint">WAV/MP3/FLAC.<!--Можно несколько.--></div>
        <div style="margin-top:10px">
  <!-- <label>ИЛИ — вставьте URL (по одному на строке):</label> -->
          <textarea id="urlList" rows="4" placeholder="https://.../sample1.wav&#10;https://.../sample2.wav"></textarea>
          <div class="row"><button id="btnLoadUrls">Загрузить URL</button><button id="btnClearList">Очистить список</button></div>
        </div>
      </div>

      <div class="panel">
        <h3>2) Выбор образца</h3>
  <!-- <label>Выберите пример:</label> -->
        <select id="sampleSelect"></select>
        <div class="row" style="margin-top:8px"><button id="btnPlay">Play</button><button id="btnStop">Stop</button></div>
        <div class="small" id="sampleInfo"></div>
      </div>

      <div class="panel">
        <h3>3) Параметры</h3>
        <label>env_sr (точек/сек): <input id="env_sr" type="number" value="100" min="10" max="2000" step="10" /></label>
        <label>topK (быстрая фильтрация): <input id="topk" type="number" value="10" min="1" max="100" /></label>
        <label>DTW frames (фикс. длина): <input id="dtw_len" type="number" value="80" min="8" max="512" /></label>
        <div style="margin-top:8px">
          <label><input type="checkbox" id="use_rms" checked /> RMS</label>
          <label><input type="checkbox" id="use_centroid" checked /> Spectral centroid</label>
          <label><input type="checkbox" id="use_hilbert" /> Hilbert</label>
        </div>
      </div>

      <div class="panel">
        <h3>4) Действия</h3>
        <div class="row">
          <button id="btnExtract">Извлечь огибающие</button>
          <button id="btnMatch">Сопоставить (L2 → DTW)</button>
          <button id="btnExport">Экспорт JSON</button>
          <button id="btnSelfTest">Self‑test</button>
          <button id="btnUnitTests">Unit‑tests</button>
        </div>
        <div class="small" id="log">Готов.</div>
      </div>

      <div class="panel">
        <h3>О феномене</h3>
        <div class="note"><strong>Важно:</strong> только пассивный анализ записей. Никакой генерации СВЧ‑сигналов.</div>
      </div>
    </div>

    <div style="flex:1">
      <div class="panel">
        <!-- <h3>Визуализация</h3> -->
        <canvas id="waveCanvas" width="900" height="120"></canvas>
        <canvas id="envCanvas" width="900" height="160" style="margin-top:8px"></canvas>
        <canvas id="dtwCanvas" width="900" height="220" style="margin-top:8px"></canvas>
      </div>
      <div class="panel">
        <h3>Результаты</h3>
        <pre id="results">Результаты появятся здесь.</pre>
        <div id="decodeHTML" class="small"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';

  // === Панель ===
  var toggleBtn = document.getElementById('btnToggleSidebar');
  if (toggleBtn) {
    toggleBtn.addEventListener('click', function(){
      document.body.classList.toggle('sidebar-collapsed');
    });
  }

  // === DOM ===
  var basePath = 'https://cryptq.github.io/audio/samples_test/samples/';
  var btnRetryList=document.getElementById('btnRetryList');
  var fileInput=document.getElementById('fileInput');
  var urlList=document.getElementById('urlList');
  var btnLoadUrls=document.getElementById('btnLoadUrls');
  var btnLoadDemo=document.getElementById('btnLoadDemo');
  var btnClearList=document.getElementById('btnClearList');
  var sampleSelect=document.getElementById('sampleSelect');
  var btnPlay=document.getElementById('btnPlay');
  var btnStop=document.getElementById('btnStop');
  var btnExtract=document.getElementById('btnExtract');
  var btnMatch=document.getElementById('btnMatch');
  var btnExport=document.getElementById('btnExport');
  var btnSelfTest=document.getElementById('btnSelfTest');
  var btnUnitTests=document.getElementById('btnUnitTests');
  var progressBox=document.getElementById('progress');
  var progressFill=document.getElementById('progressFill');
  var progressPhase=document.getElementById('progressPhase');
  var progressPct=document.getElementById('progressPct');
  var progressElapsed=document.getElementById('progressElapsed');
  var progressEta=document.getElementById('progressEta');
  var env_sr_input=document.getElementById('env_sr');
  var topk_input=document.getElementById('topk');
  var dtw_len_input=document.getElementById('dtw_len');
  var sampleInfo=document.getElementById('sampleInfo');
  var logEl=document.getElementById('log');
  var resultsEl=document.getElementById('results');
  var decodeHTML=document.getElementById('decodeHTML');
  var waveCanvas=document.getElementById('waveCanvas');
  var envCanvas=document.getElementById('envCanvas');
  var dtwCanvas=document.getElementById('dtwCanvas');
  var waveCtx=waveCanvas.getContext('2d');
  var envCtx=envCanvas.getContext('2d');
  var dtwCtx=dtwCanvas.getContext('2d');
  var use_rms=document.getElementById('use_rms');
  var use_centroid=document.getElementById('use_centroid');
  var use_hilbert=document.getElementById('use_hilbert');

  var audioCtx=null, offlineCtx=null, sourceNode=null;
  var samples=[], currentIndex=-1, lastExtract=null, lastMatchRes=null;

  // === Init ===
  try{
    setLog('UI initialized (v2.3.9)');
    if(btnRetryList) btnRetryList.addEventListener('click', onFetchServerList);
    if(btnLoadDemo) btnLoadDemo.addEventListener('click', function(){ addDemoSamples(); populateSelect(); setLog('Демо‑сэмплы загружены'); });
    if(fileInput) fileInput.addEventListener('change', onFilesSelected);
    if(btnLoadUrls) btnLoadUrls.addEventListener('click', onUrlsLoad);
    if(btnClearList) btnClearList.addEventListener('click', function(){ samples=[]; populateSelect(); setLog('Список очищен'); });
    if(sampleSelect) sampleSelect.addEventListener('change', function(){ currentIndex=Number(sampleSelect.value); sampleInfo.textContent=samples[currentIndex]?samples[currentIndex].name:'—'; });
    if(btnPlay) btnPlay.addEventListener('click', function(){ if(currentIndex>=0) playIndex(currentIndex); else alert('Выберите образец'); });
    if(btnStop) btnStop.addEventListener('click', stopPlayback);
    if(btnExtract) btnExtract.addEventListener('click', onExtract);
    if(btnMatch) btnMatch.addEventListener('click', function(){ matchSelected().catch(function(e){ console.error(e); alert('Match failed: '+(e&&e.message?e.message:e)); }); });
    if(btnExport) btnExport.addEventListener('click', onExport);
    if(btnSelfTest) btnSelfTest.addEventListener('click', runSelfTest);
    if(btnUnitTests) btnUnitTests.addEventListener('click', runUnitTests);

    addDemoSamples();
    populateSelect();
    onFetchServerList();

    window.addEventListener('error', function(ev){ console.error('Global error', ev.error||ev.message); setLog('Global error: '+(ev.message||String(ev.error))); });
    setLog('Final preview ready');
  }catch(e){ console.error('Fatal init', e); alert('Fatal init: '+(e&&e.message?e.message:e)); }

  // === Утилиты ===
  var __progressTimer=null, __progressStart=0, __progressCur=0, __progressMax=1;
  function progressStart(phase, maxUnits){
    try{
      __progressStart=performance.now(); __progressCur=0; __progressMax=Math.max(1, maxUnits||1);
      if(progressBox) progressBox.style.display='block';
      if(progressFill) progressFill.style.width='0%';
      if(progressPhase) progressPhase.textContent=String(phase||'подготовка');
      if(progressPct) progressPct.textContent='0%';
      if(progressElapsed) progressElapsed.textContent='0.0s';
      if(progressEta) progressEta.textContent='ETA —';
      if(__progressTimer) clearInterval(__progressTimer);
      __progressTimer=setInterval(function(){
        var elapsed=(performance.now()-__progressStart)/1000; if(progressElapsed) progressElapsed.textContent=elapsed.toFixed(1)+'s';
        var frac=__progressCur/Math.max(1,__progressMax); var pct=Math.max(0,Math.min(100,Math.round(frac*100)));
        if(progressPct) progressPct.textContent=pct+'%'; if(progressFill) progressFill.style.width=pct+'%';
        if(frac>0 && progressEta){ var eta=elapsed*(1-frac)/Math.max(1e-6,frac); progressEta.textContent='ETA '+eta.toFixed(1)+'s'; }
      },100);
    }catch(e){ console.warn('progressStart',e); }
  }
  function progressStep(inc, phase){ try{ __progressCur+=Math.max(0,inc||1); if(phase&&progressPhase) progressPhase.textContent=String(phase); }catch(e){ console.warn('progressStep',e); } }
  function progressDone(finalPhase){ try{ __progressCur=__progressMax; if(progressFill) progressFill.style.width='100%'; if(finalPhase&&progressPhase) progressPhase.textContent=String(finalPhase); if(__progressTimer){ clearInterval(__progressTimer); __progressTimer=null; } setTimeout(function(){ if(progressBox) progressBox.style.display='none'; },400); }catch(e){ console.warn('progressDone',e); } }
  function setDisabledDuringWork(flag){ var ctrls=[btnExtract,btnMatch,btnExport,btnSelfTest,btnUnitTests,btnRetryList,btnLoadDemo,btnLoadUrls,btnClearList,btnPlay,btnStop]; ctrls.forEach(function(b){ if(!b) return; b.disabled=!!flag; b.style.opacity=flag?0.6:1; }); }
  function setLog(msg){ if(logEl) logEl.textContent=new Date().toLocaleTimeString()+' — '+msg; console.log('[V2K]', msg); }
  function ensureAudioCtx(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); return audioCtx; }
  function safeDecodeAudioData(ab){
    ensureAudioCtx();
    return new Promise(function(resolve,reject){
      try{ var p=audioCtx.decodeAudioData(ab.slice(0)); if(p&&typeof p.then==='function'){ p.then(resolve).catch(reject); return; } }catch(_){ }
      try{ audioCtx.decodeAudioData(ab.slice(0), resolve, reject); }catch(err){ reject(err); }
    });
  }

  // === Загрузка LIST.json ===
  async function onFetchServerList(){ try{ var ok=await fetchServerList(); if(!ok) alert('Не удалось загрузить samples/LIST.json (CORS/404).'); }catch(e){ console.error(e); alert('Ошибка загрузки списка: '+(e&&e.message?e.message:e)); } }
  async function fetchServerList(){
    try{
      var r=await fetch(basePath+'LIST.json');
      if(!r.ok) throw new Error('HTTP '+r.status);
      var arr=await r.json();
      if(!Array.isArray(arr)) throw new Error('Invalid JSON');
      var add=arr.map(function(p){
        var ps=String(p||'');
        if(/^https?:\/\//i.test(ps)){
          return {name: ps.split('/').pop(), src: ps, type: 'server'};
        }
        ps = ps.replace(/^\.?\/+/, '');
        if(ps.toLowerCase().startsWith('samples/')) ps = ps.slice(8);
        var src = basePath + ps;
        return {name: ps.split('/').pop(), src: src, type: 'server'};
      });
      samples=samples.concat(add); populateSelect(); setLog('Server list loaded: '+add.length); return true;
    }catch(e){ setLog('fetchServerList failed: '+(e&&e.message?e.message:e)); return false; }
  }

  // === Источники ===
  function onFilesSelected(ev){
    try{
      var files=Array.from(ev.target.files||[]);
      if(!files.length){ setLog('Файлы не выбраны'); return; }
      var items=files.map(function(f){ return {name:f.name, src:f.name, type:'file', file:f};});
      samples=samples.concat(items);
      populateSelect();
      setLog('Loaded local files: '+files.length);
    }catch(e){ setLog('fileInput error: '+(e&&e.message?e.message:e)); }
  }
  function onUrlsLoad(){
    try{
      var lines=(urlList.value||'').split(/\r?\n/).map(function(s){return s.trim();}).filter(Boolean);
      if(!lines.length) { alert('Вставьте по одному URL на строке'); return; }
      var items=lines.map(function(u){ return {name:String(u).split('/').pop()||u, src:u, type:'url'};});
      samples=samples.concat(items);
      populateSelect();
      setLog('Loaded URLs: '+items.length);
    }catch(e){ setLog('btnLoadUrls error: '+(e&&e.message?e.message:e)); alert('Ошибка при обработке URL-ов'); }
  }
  function populateSelect(){
    sampleSelect.innerHTML='';
    samples.forEach(function(s,i){
      var opt=document.createElement('option');
      opt.value=String(i);
      var tag=s.type==='demo'?'demo':(s.type||'src');
      opt.textContent=s.name+' ['+tag+']';
      sampleSelect.appendChild(opt);
    });
    if(samples.length>0){ sampleSelect.selectedIndex=0; currentIndex=0; sampleInfo.textContent=sampleSelect.options[0].textContent; } else { currentIndex=-1; sampleInfo.textContent='Список пуст.'; }
  }

  // === Буферизация ===
  async function loadBufferFor(i){
    if(!samples[i]) throw new Error('Index out of range');
    var e=samples[i];
    if(e.buffer) return e.buffer;
    if(e.type==='demo') return e.buffer;
    if(e.type==='file'){
      var ab=await e.file.arrayBuffer(); e.buffer=await safeDecodeAudioData(ab); return e.buffer;
    }
    var r=await fetch(e.src);
    if(!r.ok) throw new Error('HTTP '+r.status+' for '+e.src);
    var ab2=await r.arrayBuffer(); e.buffer=await safeDecodeAudioData(ab2); return e.buffer;
  }

  // === Воспроизведение ===
  async function playIndex(i){
    try{
      var buf=await loadBufferFor(i);
      ensureAudioCtx();
      stopPlayback();
      var node=audioCtx.createBufferSource();
      sourceNode=node; node.buffer=buf; node.connect(audioCtx.destination); node.start();
      node.onended=function(){ if(sourceNode===node) sourceNode=null; setLog('Playback ended'); };
      drawWaveform(buf);
      setLog('Playing: '+samples[i].name);
    }catch(e){ setLog('playIndex error: '+(e&&e.message?e.message:e)); alert('Play failed: '+(e&&e.message?e.message:e)); }
  }
  function stopPlayback(){ try{ if(sourceNode){ sourceNode.stop(); sourceNode.disconnect(); sourceNode=null; setLog('Stopped'); } }catch(e){ console.warn(e); } }

  // === DSP ===
  function toMono(buf){ if(!buf) return new Float32Array(0); if(buf.numberOfChannels===1) return buf.getChannelData(0).slice(0); var L=buf.length,out=new Float32Array(L); for(var ch=0; ch<buf.numberOfChannels; ch++){ var d=buf.getChannelData(ch); for(var i=0;i<L;i++) out[i]+=d[i]/buf.numberOfChannels; } return out; }
  function normalize(a){ if(!a||!a.length) return a; var mn=Infinity,mx=-Infinity; for(var i=0;i<a.length;i++){ if(a[i]<mn) mn=a[i]; if(a[i]>mx) mx=a[i]; } var den=Math.max(1e-9,mx-mn), out=new Float32Array(a.length); for(var j=0;j<a.length;j++) out[j]=(a[j]-mn)/den; return out; }
  function linearResample(arr,N){ var out=new Float32Array(N); if(!arr||arr.length===0) return out; var L=arr.length; for(var i=0;i<N;i++){ var t=(N===1?0:i/(N-1)); var pos=t*(L-1); var i0=Math.floor(pos), i1=Math.min(L-1,i0+1); var w=pos-i0; out[i]=(1-w)*(arr[i0]||0)+w*(arr[i1]||0); } return out; }
  function nextPow2(v){ var p=1; while(p<v) p<<=1; return p; }
  function fft_inplace(re,im){ var n=re.length,j=0; for(var i=1;i<n;i++){ var bit=n>>1; for(; (j&bit); bit>>=1) j^=bit; j^=bit; if(i<j){ var tr=re[i]; re[i]=re[j]; re[j]=tr; var ti=im[i]; im[i]=im[j]; im[j]=ti; } } for(var len=2; len<=n; len<<=1){ var ang=-2*Math.PI/len, wrlen=Math.cos(ang), wilen=Math.sin(ang); for(i=0;i<n;i+=len){ var wr=1, wi=0; for(var k=0;k<len/2;k++){ var ur=re[i+k], ui=im[i+k]; var vr=re[i+k+len/2]*wr - im[i+k+len/2]*wi; var vi=re[i+k+len/2]*wi + im[i+k+len/2]*wr; re[i+k]=ur+vr; im[i+k]=ui+vi; re[i+k+len/2]=ur-vr; im[i+k+len/2]=ui-vi; var tmp=wr*wrlen - wi*wilen; wi=wr*wilen + wi*wrlen; wr=tmp; } } } }
  function ifft_inplace(re,im){ for(var i=0;i<im.length;i++) im[i]=-im[i]; fft_inplace(re,im); for(i=0;i<re.length;i++){ re[i]/=re.length; im[i]=-im[i]/re.length; } }
  function magnitudeSpectrum(frame){ var L=frame.length,N=nextPow2(L); var re=new Float64Array(N), im=new Float64Array(N); for(var i=0;i<L;i++) re[i]=frame[i]; for(i=L;i<N;i++){ re[i]=0; im[i]=0; } fft_inplace(re,im); var M=Math.floor(N/2)+1, mag=new Float32Array(M); for(var k=0;k<M;k++) mag[k]=Math.hypot(re[k],im[k]); return {mag:mag,N:N}; }
  function analyticEnvelope(frame){ var L=frame.length,N=nextPow2(L); var re=new Float64Array(N), im=new Float64Array(N); for(var i=0;i<L;i++){ re[i]=frame[i]; im[i]=0; } for(i=L;i<N;i++){ re[i]=0; im[i]=0; } fft_inplace(re,im); var half=Math.floor(N/2); for(var k=1;k<half;k++){ re[k]*=2; im[k]*=2; re[N-k]=0; im[N-k]=0; } ifft_inplace(re,im); var env=new Float32Array(L); for(var n=0;n<L;n++) env[n]=Math.hypot(re[n],im[n]); return env; }
  function spectralCentroidFromFrame(frame, sr){ try{ var spec=magnitudeSpectrum(frame), mag=spec.mag, N=spec.N; var wsum=0,sum=0; for(var k=0;k<mag.length;k++){ var a=mag[k]; var f=k*(sr/N); wsum+=a; sum+=a*f; } return wsum>0?sum/wsum:0; }catch(e){ return 0; } }

  // === Извлечение огибающих ===
  async function extractEnvelopes(buffer, env_sr){ if(!buffer) throw new Error('empty buffer'); var sr=buffer.sampleRate||44100; var mono=toMono(buffer); var hop=Math.max(1, Math.floor(sr/env_sr)); var win=Math.min(2048, hop*4); var nFrames=Math.max(1, Math.ceil(mono.length/hop)); var rms=new Float32Array(nFrames), cent=new Float32Array(nFrames), hilb=new Float32Array(nFrames); for(var i=0;i<nFrames;i++){ var start=i*hop; var frame=mono.subarray(start, Math.min(start+win, mono.length)); if(frame.length===0){ rms[i]=cent[i]=hilb[i]=0; continue; } var s=0; for(var j=0;j<frame.length;j++) s+=frame[j]*frame[j]; rms[i]=Math.sqrt(s/Math.max(1,frame.length)); cent[i]=spectralCentroidFromFrame(frame, sr); var aenv=analyticEnvelope(frame), es=0; for(j=0;j<aenv.length;j++) es+=Math.abs(aenv[j]); hilb[i]=es/Math.max(1,aenv.length); } return {rms:normalize(rms), cent:normalize(cent), hilb:normalize(hilb), sr:sr, frames:nFrames}; }

  // === Рисование ===
  function clearCanvas(ctx,W,H){ ctx.clearRect(0,0,W,H); ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H); }
  function drawWaveform(buffer){ try{ clearCanvas(waveCtx, waveCanvas.width, waveCanvas.height); if(!buffer) return; var mono=toMono(buffer); var W=waveCanvas.width,H=waveCanvas.height; waveCtx.beginPath(); waveCtx.strokeStyle='#222'; waveCtx.lineWidth=1; for(var x=0;x<W;x++){ var i=Math.floor(x*(mono.length-1)/(W-1)); var v=mono[i]||0; var y=Math.round((1-(v+1)/2)*H); if(x===0) waveCtx.moveTo(x,y); else waveCtx.lineTo(x,y); } waveCtx.stroke(); }catch(e){ console.error('drawWave',e); } }
  function drawEnvelopes(env, candidates){
    try{
      clearCanvas(envCtx, envCanvas.width, envCanvas.height);
      if(!env) return;
      var W=envCanvas.width,H=envCanvas.height;
      var methods=[];
      if(use_rms && use_rms.checked && env.rms) methods.push({key:'rms',col:'#000',label:'RMS'});
      if(use_centroid && use_centroid.checked && env.cent) methods.push({key:'cent',col:'#2c7',label:'Centroid'});
      if(use_hilbert && use_hilbert.checked && env.hilb) methods.push({key:'hilb',col:'#e74c3c',label:'Hilbert'});
      methods.forEach(function(m){ var arr=env[m.key]; if(!arr) return; var samp=linearResample(arr, W); envCtx.beginPath(); envCtx.lineWidth=(m.key==='rms'?2:1.6); envCtx.strokeStyle=m.col; for(var x=0;x<W;x++){ var y=H - samp[x]*(H-30) - 10; if(x===0) envCtx.moveTo(x,y); else envCtx.lineTo(x,y); } envCtx.stroke(); });
      if(Array.isArray(candidates)){
        var cols=['#f39c12','#27ae60','#8e44ad','#3498db'], ci=0;
        candidates.slice(0,4).forEach(function(c){
          var col=cols[ci++%cols.length];
          ['rms','cent','hilb'].forEach(function(k){ if(!c.env[k]) return; var samp=linearResample(c.env[k], W); envCtx.beginPath(); envCtx.lineWidth=1; envCtx.strokeStyle=col; for(var x=0;x<W;x++){ var y=H - samp[x]*(H-30) - 10; if(x===0) envCtx.moveTo(x,y); else envCtx.lineTo(x,y); } envCtx.stroke(); });
        });
      }
      envCtx.fillStyle='#111'; envCtx.font='12px Arial'; var lx=10; methods.forEach(function(m){ envCtx.fillStyle=m.col; envCtx.fillRect(lx,8,14,8); envCtx.fillStyle='#111'; envCtx.fillText(m.label, lx+20, 16); lx+=120; });
    }catch(e){ console.error('drawEnvelopes',e); }
  }
  function dtw1d(a,b){ var n=a.length,m=b.length; if(n===0||m===0) return {cost:Infinity,path:[]}; var D=new Array(n+1); for(var i=0;i<=n;i++){ D[i]=new Float64Array(m+1); for(var j=0;j<=m;j++) D[i][j]=Infinity; } D[0][0]=0; for(i=1;i<=n;i++){ for(j=1;j<=m;j++){ var d=a[i-1]-b[j-1]; var c=d*d; var v=Math.min(D[i-1][j],D[i][j-1],D[i-1][j-1]); D[i][j]=c+v; } } var ii=n,jj=m,path=[]; while(ii>0&&jj>0){ path.push([ii-1,jj-1]); var v2=Math.min(D[ii-1][jj-1],D[ii-1][jj],D[ii][jj-1]); if(v2===D[ii-1][jj-1]){ii--;jj--;} else if(v2===D[ii-1][jj]){ii--;} else {jj--;} } path.reverse(); return {cost:D[n][m], path:path}; }
  function drawDTWMatrix(a,b,path){ try{ clearCanvas(dtwCtx, dtwCanvas.width, dtwCanvas.height); if(!a||!b||a.length===0||b.length===0) return; var n=a.length,m=b.length,W=dtwCanvas.width,H=dtwCanvas.height; var maxv=0, C=new Float32Array(n*m); for(var ii=0;ii<n;ii++){ for(var jj=0;jj<m;jj++){ var v=Math.abs(a[ii]-b[jj]); C[ii*m+jj]=v; if(v>maxv) maxv=v; } } var cellW=Math.max(1,Math.floor(W/m)), cellH=Math.max(1,Math.floor(H/n)); for(ii=0;ii<n;ii++){ for(jj=0;jj<m;jj++){ var vv=C[ii*m+jj]/(maxv+1e-9); var col=Math.floor(255*(1-vv)); dtwCtx.fillStyle='rgb('+col+','+col+','+col+')'; dtwCtx.fillRect(jj*cellW, ii*cellH, cellW, cellH); } } if(path&&path.length){ dtwCtx.strokeStyle='#0fb'; dtwCtx.lineWidth=2; dtwCtx.beginPath(); for(var k=0;k<path.length;k++){ var p=path[k]; var x=p[1]*cellW+cellW/2; var y=p[0]*cellH+cellH/2; if(k===0) dtwCtx.moveTo(x,y); else dtwCtx.lineTo(x,y); } dtwCtx.stroke(); } }catch(e){ console.error('drawDTWMatrix',e); } }
  function l2dist(a,b){ var N=Math.min(a.length,b.length); if(N===0) return Infinity; var s=0; for(var i=0;i<N;i++){ var d=a[i]-b[i]; s+=d*d; } return Math.sqrt(s/N); }
  function combineFeature(env, dtwLen, use){ var parts=[]; if(use.rms&&env.rms) parts.push(linearResample(env.rms,dtwLen)); if(use.cent&&env.cent) parts.push(linearResample(env.cent,dtwLen)); if(use.hilb&&env.hilb) parts.push(linearResample(env.hilb,dtwLen)); if(parts.length===0) return linearResample(env.rms||env.cent||env.hilb||new Float32Array(dtwLen), dtwLen); var out=new Float32Array(dtwLen); for(var i=0;i<parts.length;i++){ var p=normalize(parts[i]); for(var j=0;j<dtwLen;j++) out[j]+=p[j]||0; } for(var j2=0;j2<dtwLen;j2++) out[j2]/=Math.max(1,parts.length); return out; }
  function perMethodDTW(qenv,cenv,dtwLen){ var a_r=linearResample(qenv.rms,dtwLen), b_r=linearResample(cenv.rms,dtwLen); var a_c=linearResample(qenv.cent,dtwLen), b_c=linearResample(cenv.cent,dtwLen); var a_h=linearResample(qenv.hilb,dtwLen), b_h=linearResample(cenv.hilb,dtwLen); return {rms:dtw1d(a_r,b_r).cost, cent:dtw1d(a_c,b_c).cost, hilb:dtw1d(a_h,b_h).cost}; }
  function escapeHTML(s){ var map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }; return String(s).replace(/[&<>"']/g, function(ch){ return map[ch] || ch; }); }
  function fmt(x){ return isFinite(x)?Number(x).toFixed(6):'—'; }
  function renderDecodeTable(queryName, dtwResults, qenv, pool, dtwLen){ if(!decodeHTML) return; if(!dtwResults||!dtwResults.length){ decodeHTML.innerHTML='<div>Нет результатов.</div>'; return; } var best=dtwResults[0]; var html='<div style="margin:6px 0 10px"><span class="pill">Декодировано как: <strong>'+escapeHTML(best.name)+'</strong></span><span class="badge">query: '+escapeHTML(queryName)+'</span></div>'; html+='<table><thead><tr><th>#</th><th>Сэмпл</th><th>DTW (сумм.)</th><th>RMS</th><th>Centroid</th><th>Hilbert</th><th>L2</th><th>Действия</th></tr></thead><tbody>'; for(var i=0;i<Math.min(10,dtwResults.length);i++){ var d=dtwResults[i], cenv=null; for(var pi=0;pi<pool.length;pi++){ if(pool[pi].index===d.index){ cenv=pool[pi].env; break; } } var pm=cenv?perMethodDTW(qenv,cenv,dtwLen):{rms:NaN,cent:NaN,hilb:NaN}; html+='<tr><td>'+(i+1)+'</td><td>'+escapeHTML(d.name)+'</td><td>'+fmt(d.dtw_cost)+'</td><td>'+fmt(pm.rms)+'</td><td>'+fmt(pm.cent)+'</td><td>'+fmt(pm.hilb)+'</td><td>'+fmt(d.coarse_score)+'</td><td><span class="play" data-play-index="'+d.index+'">▶ прослушать</span></td></tr>'; } html+='</tbody></table>'; decodeHTML.innerHTML=html; var links=decodeHTML.querySelectorAll('[data-play-index]'); for(var k=0;k<links.length;k++){ links[k].addEventListener('click', function(ev){ var idx=Number(ev.currentTarget.getAttribute('data-play-index')); if(!isNaN(idx)) playIndex(idx); }); } }

  // === Пайплайн сопоставления ===
  async function matchSelected(){
    if(currentIndex<0){ alert('Выберите образец'); return; }
    var t0=performance.now();
    setDisabledDuringWork(true);
    var entry=samples[currentIndex];
    var env_sr=Math.max(10, parseInt(env_sr_input.value,10)||100);
    var dtwLen=Math.max(8, parseInt(dtw_len_input.value,10)||80);
    var topK=Math.max(1, parseInt(topk_input.value,10)||10);
    var N=Math.max(1, samples.length-1);
    progressStart('Подготовка', 1 + 3 + 3*N + 1*N + 4*topK);
    try{
      setLog('Matching for: '+entry.name);
      progressStep(1,'Загрузка запроса');
      var bufQ=await loadBufferFor(currentIndex); drawWaveform(bufQ);
      progressStep(1,'Извлечение огибающих запроса');
      var qenv=await extractEnvelopes(bufQ, env_sr);
      progressStep(1,'Готовим кандидатов');
      var pool=[];
      for(var i=0;i<samples.length;i++){
        if(i===currentIndex) continue;
        try{
          var b=await loadBufferFor(i); progressStep(1,'Загружен кандидат #'+i);
          var env=await extractEnvelopes(b, env_sr); progressStep(2,'Огибающие кандидата #'+i);
          pool.push({index:i, name:samples[i].name, env:env});
        }catch(e){ console.warn('skip candidate', samples[i]&&samples[i].src, e&&e.message?e.message:e); }
        if(pool.length>=200) break;
      }
      setLog('Candidates prepared: '+pool.length);
      progressPhase.textContent='Быстрая фильтрация (L2)';
      var coarse=pool.map(function(p){
        progressStep(1);
        var qv = linearResample(qenv.rms, Math.min(qenv.rms.length, Math.max(1, Math.floor(env_sr))));
        var pv = linearResample(p.env.rms, qv.length);
        return { index:p.index, name:p.name, score:l2dist(qv, pv), env:p.env };
      });
      coarse.sort(function(a,b){return a.score-b.score;});
      var shortlist=coarse.slice(0, Math.min(topK,coarse.length));
      var useFlags={rms:use_rms.checked, cent:use_centroid.checked, hilb:use_hilbert.checked};
      var dtwResults=[], qCombo=combineFeature(qenv, dtwLen, useFlags);
      progressPhase.textContent='Точное выравнивание (DTW)';
      for(var si=0; si<shortlist.length; si++){
        var s=shortlist[si];
        try{ var b2=combineFeature(s.env, dtwLen, useFlags); var r=dtw1d(qCombo,b2); dtwResults.push({name:s.name, index:s.index, coarse_score:s.score, dtw_cost:r.cost, path:r.path}); }catch(e){ console.warn('dtw fail', e); }
        progressStep(4, 'DTW '+(si+1)+'/'+shortlist.length);
      }
      dtwResults.sort(function(A,B){return A.dtw_cost-B.dtw_cost;});
      var topCandidates=[];
      for(var ti=0; ti<Math.min(6, dtwResults.length); ti++){
        var d=dtwResults[ti], envF=null; for(var pi=0; pi<pool.length; pi++){ if(pool[pi].index===d.index){ envF=pool[pi]; break; } }
        if(envF) topCandidates.push({name:d.name, env:envF.env});
      }
      drawEnvelopes(qenv, topCandidates);
      if(dtwResults.length>0){ var best=dtwResults[0], cand=null; for(var pi2=0; pi2<pool.length; pi2++){ if(pool[pi2].index===best.index){ cand=pool[pi2]; break; } } if(cand){ var b3=combineFeature(cand.env, dtwLen, useFlags); drawDTWMatrix(qCombo,b3,best.path); } }
      var out = [ 'Query: '+entry.name, 'Candidates: '+dtwResults.length, '', 'Top results (combined DTW):', 'No  Name                          DTW_cost', '----------------------------------------' ].join('\n');
      for(var ri=0; ri<Math.min(10, dtwResults.length); ri++){ var rline=dtwResults[ri]; var no=String(ri+1); var namePad=(rline.name+Array(31).join(' ')).slice(0,30); out += '\n' + (no.length<3?no+Array(4-no.length).join(' '):no+' ') + ' ' + namePad + ' ' + rline.dtw_cost.toFixed(6); }
      resultsEl.textContent = out;
      renderDecodeTable(entry.name, dtwResults, qenv, pool, dtwLen);
      lastMatchRes={query:entry.name, results:dtwResults}; window.__last_match=lastMatchRes;
      var t1=performance.now(); setLog('Match complete in '+((t1-t0)/1000).toFixed(2)+'s');
    }catch(e){ console.error('Match failed', e); alert('Match failed: '+(e&&e.message?e.message:e)); }
    finally{ progressDone('Готово'); setDisabledDuringWork(false); }
  }

  // === Извлечение отдельно ===
  async function onExtract(){
    try{
      if(currentIndex<0) { alert('Выберите образец'); return; }
      setDisabledDuringWork(true);
      progressStart('Извлечение огибающих', 3);
      var buf=await loadBufferFor(currentIndex);
      progressStep(1,'Загружен буфер');
      drawWaveform(buf);
      var env_sr=Math.max(10, parseInt(env_sr_input.value,10)||100);
      var env=await extractEnvelopes(buf, env_sr);
      progressStep(2,'Расчёт признаков');
      lastExtract={index:currentIndex, env:env};
      window.__last_extract=lastExtract;
      drawEnvelopes(env, []);
      resultsEl.textContent='Extracted envelopes for '+samples[currentIndex].name+': rms len='+env.rms.length+', cent len='+env.cent.length+', hilb len='+env.hilb.length;
      decodeHTML.innerHTML='';
      setLog('Extract done');
    }catch(e){ console.error('extract error', e); alert('Ошибка извлечения: '+(e&&e.message?e.message:e)); }
    finally{ progressDone('Готово'); setDisabledDuringWork(false); }
  }

  // === Экспорт ===
  function onExport(){
    try{
      var payload={ samples:samples.map(function(s){return {name:s.name, src:s.src, type:s.type};}), lastExtract:lastExtract, lastMatchRes:lastMatchRes };
      var blob=new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      var url=URL.createObjectURL(blob);
      var a=document.createElement('a'); a.href=url; a.download='v2k_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      setLog('Export saved');
    }catch(e){ console.error('export',e); alert('Export failed: '+(e&&e.message?e.message:e)); }
  }

  // === Тесты ===
  async function runSelfTest(){
    try{
      addDemoSamples(); populateSelect(); currentIndex=0; sampleSelect.value='0';
      var bufQ=await loadBufferFor(currentIndex);
      var env_sr=120, dtwLen=64;
      var qenv=await extractEnvelopes(bufQ, env_sr);
      function comb(env){ return combineFeature(env, dtwLen, {rms:true, cent:true, hilb:true}); }
      var a=comb(qenv);
      var b1=comb(await extractEnvelopes(await loadBufferFor(1), env_sr));
      var b2=comb(await extractEnvelopes(await loadBufferFor(2), env_sr));
      var d1=dtw1d(a,b1).cost, d2=dtw1d(a,b2).cost;
      resultsEl.textContent = 'Self-test:\n' + ' DTW(a, demo[1])='+d1.toFixed(4)+'\n' + ' DTW(a, demo[2])='+d2.toFixed(4);
      setLog('Self-test done');
    }catch(e){ console.error('self-test',e); alert('Self-test failed: '+(e&&e.message?e.message:e)); }
  }
  function runUnitTests(){
    var tests=[];
    try{
      var syntaxOk=false; try{ new Function('return 1')(); syntaxOk=true; }catch(e){ syntaxOk=false; }
      tests.push(['Syntax engine alive', syntaxOk]);
      var rs=linearResample(Float32Array.from([0,1,0,1]),5); tests.push(['linearResample len=5', rs.length===5]);
      var emptyCost=dtw1d(new Float32Array(0), new Float32Array(10)).cost; tests.push(['DTW guard empty', emptyCost===Infinity]);
      var mres=magnitudeSpectrum(Float32Array.from([1,0,0,0])); tests.push(['magnitudeSpectrum ok', !!(mres&&mres.mag&&mres.mag.length>0)]);
      var norm=normalize(Float32Array.from([2,2,2])); tests.push(['normalize const->zeros', norm[0]===0 && norm[1]===0 && norm[2]===0]);
      var ae=analyticEnvelope(Float32Array.from([0,1,0,1,0,1])); tests.push(['analyticEnvelope length=6', !!ae && ae.length===6]);
      var demoText='http://a\nhttp://b\nhttp://c'; var splitOk = demoText.split(/\r?\n/).length===3; tests.push(['split /r?n/ works', splitOk]);
      var reportLines=['A','B','C'].join('\n'); var reJoin = /A\nB\nC/; tests.push(['join("\n") produces single string', reJoin.test(reportLines)]);
      var expectedEsc = '&lt;div title=&quot;x&quot;&gt;O&#39;K&lt;/div&gt;'; var actualEsc = escapeHTML('<div title="x">O\'K</div>'); tests.push(['escapeHTML div/quotes ok', expectedEsc===actualEsc]);
      try { drawDTWMatrix(Float32Array.from([0,1]), Float32Array.from([1,0]), [[0,0],[1,1]]); tests.push(['drawDTWMatrix no-throw', true]); } catch (_) { tests.push(['drawDTWMatrix no-throw', false]); }
      var cf = combineFeature({rms:new Float32Array([0,1]), cent:new Float32Array([1,0]), hilb:new Float32Array([0.5,0.5])}, 16, {rms:true,cent:true,hilb:true}); tests.push(['combineFeature len=16', cf.length===16]);
      var pm = perMethodDTW({rms:new Float32Array([0,1]), cent:new Float32Array([0,1]), hilb:new Float32Array([0,1])},{rms:new Float32Array([0,1]), cent:new Float32Array([1,0]), hilb:new Float32Array([0,1])}, 16); tests.push(['perMethodDTW numbers', Number.isFinite(pm.rms)&&Number.isFinite(pm.cent)&&Number.isFinite(pm.hilb)]);
      var dtwEq = dtw1d(Float32Array.from([0,1,2]), Float32Array.from([0,1,2])).cost; tests.push(['DTW equal ~0', dtwEq < 1e-9]);
      tests.push(['l2dist equal =0', l2dist(Float32Array.from([0,1]), Float32Array.from([0,1]))===0]);
      var deNoThrow = (function(){ try{ drawEnvelopes({rms:new Float32Array([0,1]), cent:new Float32Array([0,1]), hilb:new Float32Array([0,1])}, []); return true; } catch (_) { return false; } })(); tests.push(['drawEnvelopes no-throw', deNoThrow]);
      var okCount=tests.filter(function(t){return t[1];}).length;
      var report = tests.map(function(t){ return (t[1]?'[OK] ':'[FAIL] ')+t[0]; }).join('\n');
      resultsEl.textContent = 'Unit-tests:\n' + report + '\nTotal: ' + okCount + '/' + tests.length;
      setLog('Unit-tests done');
    }catch(e){ console.error('Unit-tests fatal', e); alert('Unit-tests fatal: '+(e&&e.message?e.message:e)); }
  }

  // === Синтетические демо ===
  function addDemoSamples(){
    if(window.__demoAdded) return; // защита от повторов
    if(!offlineCtx) offlineCtx=new (window.OfflineAudioContext||window.webkitOfflineAudioContext)(1, 48000*2, 48000);
    var sr=offlineCtx.sampleRate;
    function synthTone(freq,dur,amFreq,name){ freq=freq||440; dur=dur||0.9; amFreq=amFreq||6; name=name||'тон'; var length=Math.floor(dur*sr); var buf=offlineCtx.createBuffer(1,length,sr); var ch=buf.getChannelData(0); for(var n=0;n<length;n++){ var t=n/sr; var am=0.5*(1+Math.sin(2*Math.PI/Math.max(1,amFreq)*t)); ch[n]=0.6*am*Math.sin(2*Math.PI/Math.max(1,freq)*t); } return {name:name, buffer:buf}; }
    function synthClickTrain(rate,dur,name){ rate=rate||7; dur=dur||1.1; name=name||'щелчки'; var length=Math.floor(dur*sr); var buf=offlineCtx.createBuffer(1,length,sr); var ch=buf.getChannelData(0); var step=Math.max(1,Math.floor(sr/Math.max(1,rate))); for(var n=0;n<length;n++){ if(n%step===0){ ch[n]=1.0; if(n+1<length) ch[n+1]=-0.8; } ch[n]*=0.6; } return {name:name, buffer:buf}; }
    function synthSweep(f0,f1,dur,name){ f0=Math.max(1,f0||250); f1=Math.max(f0+1,f1||2200); dur=dur||1.2; name=name||'свип'; var length=Math.floor(dur*sr); var buf=offlineCtx.createBuffer(1,length,sr); var ch=buf.getChannelData(0); for(var n=0;n<length;n++){ var t=n/sr; var f=f0*Math.pow(f1/f0, t/dur); ch[n]=0.55*Math.sin(2*Math.PI*f*t); } return {name:name, buffer:buf}; }
    var bank=[
      synthTone(440,0.9,6,'демо‑A (низкий тон)'),
      synthTone(880,0.9,5,'демо‑B (высокий тон)'),
      synthSweep(250,2200,1.2,'демо‑C (свип)'),
      synthClickTrain(7,1.1,'демо‑D (щелчки)'),
      synthTone(660,0.9,12,'демо‑E (AM тон)')
    ];
    var items=bank.map(function(b){ return {name:b.name, src:'demo:'+b.name, type:'demo', buffer:b.buffer}; });
    samples = items.concat(samples);
    window.__demoAdded=true;
  }

})();
</script>
</body>
</html>
